/*

iBooks Pro C
Browser library source file

(c)2013 - 2017 Xhorizon, Some rights reserved.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

#include "fxchslib.h"
#include "string_e.h"
#include "browser.h"

const char Menu_Main[]=
{0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF9,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,
0xC0,0x0,0x0,0x0,0x0,0x0,0x0,0x19,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,
0xC0,0x8,0x0,0x0,0x0,0x10,0x0,0x19,0xFF,0xF7,0xEF,0xFF,0xFF,0xDF,0xFF,0xF0,
0xC0,0x4,0xFF,0x0,0x10,0x10,0x0,0x19,0xFF,0xF7,0xEF,0xFF,0xFF,0xDE,0xFF,0xF0,
0xC0,0x14,0x1,0x0,0xC,0xFF,0x0,0x19,0xFF,0xF7,0xD7,0xFF,0xF0,0x0,0x7F,0xF0,
0xC0,0x11,0x9,0x0,0x8,0x10,0x0,0x19,0xFF,0xF7,0xBB,0xFF,0xFF,0xDF,0xFF,0xF0,
0xC0,0x10,0x91,0x0,0x1,0xFF,0x80,0x19,0xFF,0x81,0x7D,0xFF,0xE0,0x0,0x3F,0xF0,
0xC0,0x13,0xF9,0x0,0x0,0x41,0x0,0x19,0xFF,0xF6,0xFE,0x7F,0xEF,0xBF,0xBF,0xF0,
0xC0,0x12,0x9,0x0,0x39,0x2A,0x0,0x19,0xFF,0xF5,0x1,0xFF,0xDF,0x7B,0x7F,0xF0,
0xC0,0x12,0x9,0x0,0x8,0xA8,0x0,0x19,0xFF,0xE3,0xFF,0xFF,0xFE,0xE7,0xFF,0xF0,
0xC0,0x13,0xF9,0x0,0x8,0x88,0x0,0x19,0xFF,0xE5,0xFD,0xFF,0xF8,0x1F,0xFF,0xF0,
0xC0,0x10,0xA1,0x0,0x9,0xFF,0x80,0x19,0xFF,0xD6,0xDD,0xFF,0xFF,0x7D,0xFF,0xF0,
0xC0,0x10,0xA5,0x0,0x8,0x8,0x0,0x19,0xFF,0xD6,0xDD,0xFF,0xFE,0xE0,0xFF,0xF0,
0xC0,0x11,0x25,0x0,0x8,0x14,0x0,0x19,0xFF,0xB7,0x6D,0xFF,0xF8,0x1E,0xFF,0xF0,
0xC0,0x16,0x1D,0x0,0xA,0x22,0x0,0x19,0xFF,0xF7,0x6B,0xFF,0xFF,0xDB,0xFF,0xF0,
0xC0,0x10,0x1,0x0,0xC,0x41,0x0,0x19,0xFF,0xF7,0x6B,0xFF,0xFD,0xDD,0xFF,0xE0,
0xC0,0x10,0x5,0x0,0x8,0x81,0x80,0x19,0xFF,0xF7,0xFB,0xFF,0xFB,0x5E,0x7F,0xC0,
0xC0,0x10,0x2,0x0,0x1,0x1,0x0,0x19,0xFF,0xF4,0x0,0x7F,0xE7,0xBF,0x7F,0x80,
0xC0,0x0,0x0,0x0,0x0,0x0,0x0,0x19,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF9,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x0,
0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0x0,};

const char Menu_About[]=
{0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
0xFF,0xFD,0xFB,0xFF,0xFF,0xFE,0xFF,0xF8,
0xFF,0xFE,0xFB,0xFF,0xF8,0x0,0x7F,0xF8,
0xFF,0xFF,0x77,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFF,0x6E,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xE0,0x0,0x7F,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFF,0xDF,0xFF,0xFF,0xDF,0xBF,0xF8,
0xFF,0xFF,0xDF,0xFF,0xE0,0x0,0x1F,0xF8,
0xFF,0xFF,0xDF,0x7F,0xFF,0xDF,0xFF,0xF8,
0xFF,0xC0,0x0,0x3F,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFF,0xDF,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFF,0xAF,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFF,0x77,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFE,0xFB,0xFF,0xFF,0xDF,0xFF,0xF8,
0xFF,0xFD,0xFD,0xFF,0xFF,0xDF,0xFF,0xF0,
0xFF,0xF3,0xFE,0x3F,0xFF,0x5F,0xFF,0xE0,
0xFF,0xCF,0xFF,0x7F,0xFF,0xBF,0xFF,0xC0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0,
0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x0,};

const char Menu_Clear[]=
{0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,
0xFF,0xEF,0xEF,0xFF,0xFE,0xFB,0xFF,0xF8,
0xFF,0xF3,0xEE,0xFF,0xF0,0x7B,0xFF,0xF8,
0xFF,0xFA,0x0,0x7F,0xF6,0xF5,0xFF,0xF8,
0xFF,0xFF,0xEF,0xFF,0xF6,0xEE,0xFF,0xF8,
0xFF,0xDF,0x0,0xFF,0xF5,0xDF,0x7F,0xF8,
0xFF,0xEF,0xEF,0xFF,0xF5,0xBF,0x9F,0xF8,
0xFF,0xEC,0x0,0x3F,0xF5,0x40,0x7F,0xF8,
0xFF,0xFB,0xFF,0xFF,0xF6,0xFB,0xFF,0xF8,
0xFF,0xFB,0x0,0xFF,0xF6,0xFB,0xFF,0xF8,
0xFF,0xF7,0x7E,0xFF,0xF6,0x80,0x3F,0xF8,
0xFF,0xF7,0x0,0xFF,0xF2,0xFB,0xFF,0xF8,
0xFF,0xCF,0x7E,0xFF,0xF5,0xEA,0xFF,0xF8,
0xFF,0xEF,0x0,0xFF,0xF7,0xDB,0x7F,0xF8,
0xFF,0xEF,0x7E,0xFF,0xF7,0xBB,0xBF,0xF0,
0xFF,0xEF,0x7A,0xFF,0xF7,0x6B,0xBF,0xE0,
0xFF,0xFF,0x7D,0xFF,0xF7,0xF7,0xFF,0xC0,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,
0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x0,
0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x0,};

f_name fList[100];    //  文件列表数组

int getn(f_name a[])
{
    /*
	    获取二维数组的有效项目数
        参数说明：
	        a[]: 欲获取项数的二维数组
		返回值：
		    有效项目数 (不为 0)
    */

    int i;
	for (i=0;a[i].name;++i);
	return i;
}

static int fstrlen(const FONTCHARACTER* a)
{
    /*
	    获取 FONTCHARACTER 类型的字符长度
        参数说明：
	        a: 欲获取字符长度的 FONTCHARACTER 类型
		返回值：
		    有效长度
    */
    int i;
	for (i=0;a[i];++i);
	return i;
}

static char* font_to_char(const FONTCHARACTER* ffname,char* cfname)
{
    /*
	    将 FONTCHARACTER 类型转换为字符串
        参数说明：
	        ffname: 欲转换的 FONTCHARACTER 类型
			cfname: 输出的字符串
		返回值：
		    输出的字符串
    */
    int i,len=fstrlen(ffname);

	for(i=0;i<len;++i)
		cfname[i]=ffname[i];

	cfname[i]=0;
	return cfname;
}

f_name* get_file_list(const char* path)
{
    /*
	    获取指定目录下的文件列表
        参数说明：
	        path: 指定的目录
    */
    int handle;
	FILE_INFO fInfo;    //  文件类型信息结构
    FONTCHARACTER fpath[64],fnfile[64];
	char nfile[64];
	int i=0;
	
	char_to_font(path,fpath);
	if (Bfile_FindFirst(fpath,&handle,fnfile,&fInfo)!=0)    //  如果当前目录下无文件，跳出
	    return 0;
	
	font_to_char(fnfile,nfile);
	if ((strstr(nfile,"txt"))||(fInfo.type==DT_DIRECTORY))    //  如果找到 txt 文件或文件夹
	{
	    if (!fList[0].name) 
		    fList[0].name=(char*)malloc(64);
		fList[0].name[0]='\0';
	    if (fInfo.type==DT_DIRECTORY)
		    strcat(fList[0].name,"[");
	    strcat(fList[0].name,nfile);    //  加入字符串
		fList[0].name[strlen(fList[0].name)]='\0';
	}
	else i=-1;
	
	while (Bfile_FindNext(handle,fnfile,&fInfo)==0)
	{
	    font_to_char(fnfile,nfile);
		if ((strstr(nfile,"txt"))||(fInfo.type==DT_DIRECTORY))
	    {
		    ++i;
		    if (!fList[i].name) 
		        fList[i].name=(char*)malloc(64);
			fList[i].name[0]='\0';
	        if (fInfo.type==DT_DIRECTORY)
		        strcat(fList[i].name,"[");
	        strcat(fList[i].name,nfile);    //  加入字符串
			fList[i].name[strlen(fList[i].name)]='\0';
	    }
	}
	fList[i+1].name=0;
	
	Bfile_FindClose(handle);
	
	if (i!=-1)
	    return fList;
	else
	    return 0;
}

void draw_browser(const char* path,int firstf,int selp,f_name *a)
{
    /*
	    文件浏览器 (绘制)
    */
    int i=firstf;
	int start=49+24*selp;
	char* pathcat=(char*)malloc(strlen(path)+8);
	char* tmp;
	
	strcpy(pathcat,path);
	strcat(pathcat,"\\*");
	
	Bdisp_AllClr_VRAM();
	
	print_chs_2(0,24,0x001F,"文本文档列表");
	locate_OS(12,1);
	Print_OS("[        ]",0,0);
	
	if (!strcmp(path,"\\\\fls0"))
		print_chs_2(216,24,0,"根目录");
	else
	{
	    tmp=(char*)malloc(64);
		strcpy(tmp,strrchr(path,'\\'));
		tmp[strlen(tmp)]='\0';
		locate_OS(13,1);
	    Print_OS(++tmp,0,0);
	}
	
	if (a)
	{
	    while (a[i++].name)
	    {
	        if (i>firstf+6) break;
		    locate_OS(2,i-firstf+1);
			Print_OS(a[i-1].name,0,0);
			if (strchr(a[i-1].name,'['))
			{
			    locate_OS(2+strlen(a[i-1].name),i-firstf+1);
			    Print_OS("]",0,0);
		    }
		}
	}
	
	if (a)
	{
	    if (firstf>0)
	    {
	        locate_OS(21,2);
	        Print_OS("\xe6\x92",0,0);
	    }
	    if (firstf+6<getn(a))
	    {
	        locate_OS(21,7);
	        Print_OS("\xe6\x93",0,0);
	    }
	    Bdisp_AreaReverseVRAM(0,start,384,start+22);
	}
	else
		print_chs_2(75,101,0,"无文档");
	
	draw_pic(0, 192, 124, 22, 0, Menu_Main);
	draw_pic(322, 192, 61, 22, 0, Menu_About);
	//draw_pic(126, 192, 61, 22, 0, Menu_Clear);
	
	free(pathcat);
}

int print_chs_2(int x,int y,int color,const unsigned char* str)
{
    /*
	    绘制字符串，注释详见 divide_page 函数
	*/

    int cx=x;
    int cy=y;
    int i=0;
    const int pp=18;
	int is_chs=0;
    char temp[50];
    for (;str[i];)
    {
        is_chs=str[i] & 0x80;
        if ((cx+pp)>384)
            goto cn;
        if (is_chs)
        {
            print_chs_char(cx,cy,color,str[i],str[i+1]);
            i+=2;
        }
        else
        {
            print_asc_char (cx,cy,0,str[i]);
			i++;
        }
        
		if (is_chs)
            cx+=25;
		else
		    cx+=16;
        
        if (cx>384)
        {
        cn:
            cx=x;
			cy+=25;
        }
    }
}